<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            max-width: 500px;
            margin: 80px auto;
            border-radius: 20px;
        }
        .btn {
            border-radius: 50px;
            font-size: 1.3rem;
            padding: 15px;
        }
    </style>
</head>

<body>

<div class="card shadow-lg border-0">
    <div class="card-body text-center p-5">
        <h2 class="text-primary mb-4">Welcome Back!</h2>
        <h3 class="mb-5" id="sname"></h3>

        <!-- START EXAM BUTTON -->
        <button
            id="startExamBtn"
            class="btn btn-success w-75 mb-3"
            onclick="startExam()"
            disabled
        >
            Start Exam Now
        </button>

        <!-- EXAM TIMER -->
        <div id="examTimer" class="text-center mt-4">
            <div class="alert alert-info fs-3 p-4 rounded shadow">
                <div id="timerMessage">Checking exam schedule...</div>
                <div
                    id="countdown"
                    class="fs-1 fw-bold text-danger mt-3"
                    style="display:none;"
                ></div>
            </div>
        </div>

        <br>

        <button class="btn btn-danger w-75" onclick="studentLogout()">
            Logout
        </button>
    </div>
</div>

<script>
/* =============================
   CONFIG
============================= */
const BASE_URL = "https://exam-tool-backend-clean.onrender.com";

/* =============================
   SESSION CHECK
============================= */
if (!localStorage.getItem("student_id")) {
    alert("Please login first!");
    window.location.href = "student-login.html";
}

document.getElementById("sname").innerText =
    localStorage.getItem("student_name") || "Student";

/* =============================
   EXAM TIMER LOGIC
============================= */
let examStartTime = null;
let countdownInterval = null;

function checkExamTime() {
    fetch(`${BASE_URL}/api/exam-time`)
        .then(r => r.json())
        .then(data => {
            const startBtn = document.getElementById("startExamBtn");
            const timerMsg = document.getElementById("timerMessage");
            const countdownEl = document.getElementById("countdown");

            if (!data.scheduled) {
                startBtn.disabled = true;
                timerMsg.innerHTML = "⚠️ Exam not scheduled yet by admin";
                countdownEl.style.display = "none";
                stopCountdown();
                return;
            }

            examStartTime = new Date(data.start_time + "Z");
            const now = new Date();

            if (now >= examStartTime) {
                startBtn.disabled = false;
                timerMsg.innerHTML =
                    "<span class='text-success fs-2 fw-bold'>✅ EXAM IS LIVE NOW!</span>";
                countdownEl.style.display = "none";
                stopCountdown();
            } else {
                startBtn.disabled = true;
                timerMsg.innerHTML =
                    `Exam starts at:<br><strong class="text-warning fs-3">${data.time_str}</strong>`;
                countdownEl.style.display = "block";
                startCountdown();
            }
        })
        .catch(() => {
            document.getElementById("timerMessage").innerHTML =
                "<span class='text-danger'>Server error</span>";
        });
}

function startCountdown() {
    if (countdownInterval) return; // prevent duplicates

    const countdownEl = document.getElementById("countdown");

    countdownInterval = setInterval(() => {
        const now = new Date();
        const diff = examStartTime - now;

        if (diff <= 0) {
            stopCountdown();
            location.reload();
            return;
        }

        const h = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, "0");
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, "0");
        const s = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, "0");

        countdownEl.innerText = `${h}:${m}:${s}`;
    }, 1000);
}

function stopCountdown() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}

/* =============================
   BUTTON ACTIONS
============================= */
function startExam() {
    if (document.getElementById("startExamBtn").disabled) return;
    window.location.href = "start-exam.html";
}

function studentLogout() {
    if (!confirm("Are you sure you want to logout?")) return;

    localStorage.removeItem("student_id");
    localStorage.removeItem("student_name");
    localStorage.removeItem("attempt_id");

    alert("Logged out successfully!");
    window.location.href = "student-login.html";
}

/* =============================
   AUTO POLLING
============================= */
checkExamTime();
setInterval(checkExamTime, 10000);
</script>

</body>
</html>
