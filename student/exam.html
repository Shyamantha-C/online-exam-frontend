<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; }
        .timer-box { background: #dc3545; color: white; padding: 12px; border-radius: 12px; font-weight: bold; }
        .per-q-timer { background: #0d6efd; color: white; padding: 8px 15px; border-radius: 50px; font-size: 1.1rem; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">

    <div class="text-center mb-4">
        <h3 class="mb-3">Online Exam</h3>
        <div id="overallTimer" class="timer-box d-inline-block px-4">Loading...</div>
    </div>

    <div id="qbox" class="card shadow-lg border-0"></div>

</div>

<script>
// === 1. FULLSCREEN FOREVER (NEVER EXIT) ===
const urlParams = new URLSearchParams(window.location.search);
const attempt_id = urlParams.get("attempt");
const student_id = localStorage.getItem('student_id');

// Re-enter fullscreen on load
if (urlParams.get("fs") === "1" || location.href.includes("exam.html")) {
    setTimeout(() => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }, 400);
}

// If student presses Esc → FORCE back into fullscreen + warning
document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
        reportCheat("You tried to exit fullscreen!");
        setTimeout(() => {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        }, 300);
    }
});

// === 2. ANTI-CHEATING SYSTEM (3 warnings → auto submit) ===
let cheatCount = 0;
const MAX_WARNINGS = 3;

function reportCheat(reason) {
    cheatCount++;
    if (cheatCount >= MAX_WARNINGS) {
        alert(`MAXIMUM VIOLATIONS! (${cheatCount})\n\n${reason}\n\nExam submitting now for security.`);
        submitExam();
        return;
    }
    alert(`WARNING ${cheatCount}/${MAX_WARNINGS}\n\n${reason}\n\nDo NOT switch tab, exit fullscreen, or use shortcuts.\nAfter 3 warnings → auto submit.`);
}

// Block everything
history.pushState(null, null, location.href);
window.onpopstate = () => history.go(1);
document.addEventListener("contextmenu", e => { e.preventDefault(); reportCheat("Right-click blocked"); });
document.addEventListener("copy paste cut", e => { e.preventDefault(); reportCheat("Copy/paste blocked"); });
document.addEventListener("keydown", e => {
    if (e.ctrlKey || e.altKey || ["F12", "PrintScreen", "Escape"].includes(e.key)) {
        e.preventDefault();
        reportCheat("Keyboard shortcut blocked");
    }
});
document.addEventListener("visibilitychange", () => {
    if (document.hidden) reportCheat("Tab switch detected!");
});
window.onbeforeunload = () => "Leaving will count as cheating!";

// === 3. LOAD EXAM ===
const BASE_URL = "https://online-exam-backend-f3rp.onrender.com";
let questions = [], currentIndex = 0, answers = {};

// Load questions
fetch(`${BASE_URL}/api/questions_for/${attempt_id}`)
    .then(r => r.json())
    .then(data => {
        questions = data.questions;
        if (questions.length === 0) return alert("No questions!");
        renderQuestion();
        startOverallTimer(data.total_time);
    })
    .catch(() => alert("Failed to load exam"));

// === 4. RENDER QUESTION ===
function renderQuestion() {
    const q = questions[currentIndex];
    document.getElementById('qbox').innerHTML = `
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5>Question ${currentIndex + 1} of ${questions.length}
                    <span class="badge bg-light text-dark ms-2">⏱ <span id="perQTimer">${q.per_question_time}</span>s</span>
                    ${cheatCount > 0 ? `<span class="badge bg-danger ms-2">Warnings: ${cheatCount}/${MAX_WARNINGS}</span>` : ''}
                </h5>
            </div>
            <div class="card-body p-4">
                <h4 class="mb-4">${q.text}</h4>
                <div class="options">
                    ${['A','B','C','D'].map(l => `
                        <div class="form-check mb-3 p-3 border rounded bg-light">
                            <input class="form-check-input" type="radio" name="option" value="${l}" id="opt${l}">
                            <label class="form-check-label fs-5" for="opt${l}">
                                <strong>${l}.</strong> ${q.options[l]}
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-lg px-5 fw-bold ${currentIndex === questions.length-1 ? 'btn-danger' : 'btn-success'}"
                            onclick="goNext()">
                        ${currentIndex === questions.length-1 ? 'Submit Exam' : 'Next →'}
                    </button>
                </div>
                ${cheatCount > 0 ? `<div class="alert alert-danger mt-3 text-center"><strong>STOP CHEATING! Warning ${cheatCount}/3</strong></div>` : ''}
            </div>
        </div>
    `;

    startPerQuestionTimer(q.per_question_time);

    document.querySelectorAll('input[name="option"]').forEach(radio => {
        radio.onclick = () => answers[q.id] = radio.value;
    });
}

// === 5. NAVIGATION & TIMERS ===
function goNext() {
    const selected = document.querySelector('input[name="option"]:checked');
    answers[questions[currentIndex].id] = selected ? selected.value : null;

    if (currentIndex === questions.length - 1) {
        if (confirm("Submit final answers?")) submitExam();
        return;
    }
    currentIndex++;
    renderQuestion();
}

function startPerQuestionTimer(sec) {
    let t = sec;
    const el = document.getElementById('perQTimer');
    const int = setInterval(() => {
        t--;
        el.textContent = t;
        if (t <= 0) { clearInterval(int); goNext(); }
    }, 1000);
}

function startOverallTimer(totalSec) {
    let t = totalSec;
    const el = document.getElementById('overallTimer');
    setInterval(() => {
        if (t <= 0) { alert("Time Over!"); submitExam(); }
        const m = String(Math.floor(t/60)).padStart(2,'0');
        const s = String(t%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
        t--;
    }, 1000);
}

// === 6. SUBMIT EXAM (NO SCORE SHOWN) ===
function submitExam() {
    fetch(`${BASE_URL}/api/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ attempt_id: parseInt(attempt_id), answers })
    })
    .then(r => r.json())
    .then(() => {
        localStorage.removeItem('attempt_id');
        alert("Exam submitted successfully!\n\nThank you.\nResult will be declared by admin soon.");
        window.location.href = "thank-you.html";
    })
    .catch(() => alert("Submission failed. Contact admin."));
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>