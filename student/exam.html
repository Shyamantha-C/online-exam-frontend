<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; }
        .timer-box { background: #dc3545; color: white; padding: 12px; border-radius: 12px; font-weight: bold; }
        .per-q-timer { background: #0d6efd; color: white; padding: 8px 15px; border-radius: 50px; font-size: 1.1rem; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">

    <div class="text-center mb-4">
        <h3 class="mb-3">Online Exam</h3>
        <div id="overallTimer" class="timer-box d-inline-block px-4">Loading...</div>
    </div>

    <div id="qbox" class="card shadow-lg border-0"></div>

</div>

<script>
const BASE_URL = "https://online-exam-backend-f3rp.onrender.com";
const urlParams = new URLSearchParams(window.location.search);
const attempt_id = urlParams.get("attempt");
const student_id = localStorage.getItem('student_id');

let questions = [];
let currentIndex = 0;
let answers = {};
let cheatCount = 0;
const MAX_CHEAT = 3;

// Force fullscreen immediately
function goFullScreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen();
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
}

// Warning + Auto-submit after 3 violations
function reportCheat(reason = "Cheating detected") {
    cheatCount++;
    
    if (cheatCount >= MAX_CHEAT) {
        alert(`MAXIMUM VIOLATIONS REACHED (${cheatCount})\n\n${reason}\n\nYour exam is being submitted automatically for security reasons.`);
        submitExam();
        return;
    }

    alert(`WARNING ${cheatCount}/${MAX_CHEAT}\n\n${reason}\n\nDo not switch tabs, exit fullscreen, copy/paste, or use shortcuts.\nAfter 3 warnings, your exam will be auto-submitted.`);
}

// BLOCK EVERYTHING — PROFESSIONAL LEVEL
history.pushState(null, null, location.href);
window.onpopstate = () => history.go(1);

document.addEventListener("contextmenu", e => { e.preventDefault(); reportCheat("Right-click disabled"); });
document.addEventListener("copy", e => { e.preventDefault(); reportCheat("Copying disabled"); });
document.addEventListener("paste", e => { e.preventDefault(); reportCheat("Pasting disabled"); });
document.addEventListener("cut", e => { e.preventDefault(); reportCheat("Cutting disabled"); });
document.addEventListener("selectstart", e => e.preventDefault());
document.addEventListener("keydown", e => {
    if (e.ctrlKey || e.altKey || e.key === "F12" || e.key === "PrintScreen" || e.key === "Escape") {
        e.preventDefault();
        reportCheat("Keyboard shortcuts blocked");
    }
});

// Tab switch / minimize
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        reportCheat("You switched tab or minimized the window");
    }
});

// Exit fullscreen
document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
        reportCheat("You exited fullscreen mode");
        goFullScreen(); // force back to fullscreen
    }
});

// Warn before refresh/close
window.onbeforeunload = () => {
    return "Leaving or refreshing will count as a violation and may submit your exam.";
};

// Start fullscreen on load
document.addEventListener("DOMContentLoaded", goFullScreen);

// Load exam
fetch(`${BASE_URL}/api/questions_for/${attempt_id}`)
    .then(r => r.json())
    .then(data => {
        questions = data.questions;
        if (questions.length === 0) return alert("No questions found!");
        renderQuestion();
        startOverallTimer(data.total_time);
    })
    .catch(() => alert("Failed to load exam"));

// Render current question
function renderQuestion() {
    const q = questions[currentIndex];

    document.getElementById('qbox').innerHTML = `
        <div class="card-header bg-danger text-white text-center py-3">
            <h5 class="mb-0">
                Question ${currentIndex + 1} of ${questions.length}
                <span class="badge bg-light text-danger fs-6">⏱ <span id="perQTimer">${q.per_question_time}</span>s</span>
                <span class="badge bg-warning text-dark ms-2">Warnings: ${cheatCount}/${MAX_CHEAT}</span>
            </h5>
        </div>

        <div class="card-body p-4">
            <h4 class="mb-4">${q.text}</h4>

            <div class="options">
                ${['A', 'B', 'C', 'D'].map(letter => `
                    <div class="form-check mb-3 p-3 border rounded bg-light">
                        <input class="form-check-input" type="radio" name="option" id="opt${letter}" value="${letter}">
                        <label class="form-check-label fs-5" for="opt${letter}">
                            <strong>${letter}.</strong> ${q.options[letter]}
                        </label>
                    </div>
                `).join('')}
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-lg px-5 fw-bold ${
                    currentIndex === questions.length - 1 ? 'btn-danger' : 'btn-success'
                }" onclick="goNext()">
                    ${currentIndex === questions.length - 1 ? 'Submit Exam' : 'Next →'}
                </button>
            </div>

            ${cheatCount > 0 ? `
            <div class="alert alert-danger text-center mt-3">
                <strong>WARNING ${cheatCount}/${MAX_CHEAT}</strong> - Stop cheating or exam will auto-submit!
            </div>` : ''}
        </div>
    `;

    startPerQuestionTimer(q.per_question_time);

    document.querySelectorAll('input[name="option"]').forEach(radio => {
        radio.onclick = () => answers[q.id] = radio.value;
    });
}

function goNext() {
    const selected = document.querySelector('input[name="option"]:checked');
    answers[questions[currentIndex].id] = selected ? selected.value : null;

    if (currentIndex === questions.length - 1) {
        if (confirm("Submit final answers?")) submitExam();
        return;
    }
    currentIndex++;
    renderQuestion();
}

function startPerQuestionTimer(seconds) {
    let time = seconds;
    const el = document.getElementById('perQTimer');
    const interval = setInterval(() => {
        time--;
        el.textContent = time;
        if (time <= 0) {
            clearInterval(interval);
            goNext();
        }
    }, 1000);
}

function startOverallTimer(totalSeconds) {
    let time = totalSeconds;
    const el = document.getElementById('overallTimer');
    const interval = setInterval(() => {
        const m = String(Math.floor(time / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        el.textContent = `${m}:${s}`;
        if (time <= 0) {
            clearInterval(interval);
            alert("Time Over!");
            submitExam();
        }
        time--;
    }, 1000);
}

function submitExam() {
    fetch(`${BASE_URL}/api/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            attempt_id: parseInt(attempt_id),
            answers: answers
        })
    })
    .then(r => r.json())
    .then(res => {
        alert(`Exam Submitted!\nScore: ${res.score}/${questions.length}\nWarnings: ${cheatCount}`);
        localStorage.removeItem('attempt_id');
        window.location.href = `exam-complete.html?score=${res.score}&total=${questions.length}&warnings=${cheatCount}`;
    })
    .catch(() => alert("Submission failed"));
}
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>