<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Students - Excel List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
        .card { background: #1e293b; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .table { background: #334155; }
        .table th { background: #6366f1 !important; color: white; }
        .print-btn { border-radius: 50px; padding: 15px 60px; font-size: 1.4rem; font-weight: bold; }
        @media print { body { background: white; color: black; } .no-print { display: none; } }
    </style>
</head>
<body class="p-4">

<div class="container">
    <div class="card">
        <div class="text-center py-5 bg-primary rounded-top">
            <h1 class="display-4 fw-bold">ALL STUDENTS FROM EXCEL</h1>
            <p class="lead fs-3">Total Students: <span id="totalCount" class="text-warning">Loading...</span></p>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover text-white mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                        </tr>
                    </thead>
                    <tbody id="studentsBody">
                        <tr><td colspan="4" class="text-center py-5"><h3>Loading from Excel...</h3></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PRINT BUTTON -->
        <div class="card-footer text-center py-5 bg-dark no-print">
            <button onclick="magicPrint()" class="btn btn-success print-btn shadow-lg">
                üñ®Ô∏è PRINT / DOWNLOAD STUDENT LIST PDF
            </button>
            <button onclick="history.back()" class="btn btn-secondary print-btn ms-3">
                ‚Üê BACK TO DASHBOARD
            </button>
        </div>
    </div>
</div>

<!-- PRINT KA JAADU (100% WORKING) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
async function magicPrint() {
    await new Promise(r => setTimeout(r, 1000));
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.body, { 
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
    });
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save(`All_Students_List_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>

<script>
fetch("https://exam-tool-backend-clean.onrender.com/api/admin/excel-students", {
    headers: { "X-ADMIN-TOKEN": localStorage.getItem("adminToken") }
})
.then(r => r.json())
.then(data => {
    const tbody = document.getElementById("studentsBody");
    document.getElementById("totalCount").textContent = data.total || data.students.length;

    tbody.innerHTML = "";

    if (!data.students || data.students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted fs-2">No students in Excel</td></tr>`;
        return;
    }

    data.students.forEach((s, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="fw-bold fs-5">${i + 1}</td>
            <td class="fw-bold">${s.name || "‚Äî"}</td>
            <td>${s.email}</td>
            <td>${s.phone}</td>
        `;
        tbody.appendChild(row);
    });
})
.catch(() => {
    document.getElementById("studentsBody").innerHTML = `<tr><td colspan="4" class="text-center text-danger py-5 fs-3">Failed to load</td></tr>`;
});
</script>

</body>
</html>