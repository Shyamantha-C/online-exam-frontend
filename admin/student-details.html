<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .table {
            margin: 0;
        }
        .table th {
            background-color: #4e73df !important;
            color: white;
            font-weight: 600;
        }
        .btn-back {
            border-radius: 50px;
            padding: 12px 50px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .badge-completed { background-color: #1cc88a; }
        .badge-progress { background-color: #f6c23e; color: black; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="card bg-white text-dark">
        <div class="header">
            <h1 class="mb-2">ALL STUDENTS DETAIL</h1>
            <p class="mb-0 fs-5">Complete Student Database</p>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Started At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentsList">
                        <!-- JS fills here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer bg-light text-center py-4">
            <button onclick="history.back()" class="btn btn-secondary btn-back">
                ← Back
            </button>
        </div>
    </div>
</div>

<script>
// Admin token check
if (!localStorage.getItem("adminToken")) {
    alert("Unauthorized access!");
    window.location.href = "admin-login.html";
    throw new Error("Stop");
}

// Load all students
fetch("https://online-exam-backend-f3rp.onrender.com/api/results", {
    headers: { "X-ADMIN-TOKEN": localStorage.getItem("adminToken") }
})
.then(r => r.json())
.then(data => {
    const tbody = document.getElementById("studentsList");
    tbody.innerHTML = "";

    if (!data.results || data.results.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center py-5 text-muted fs-3">No students found</td></tr>`;
        return;
    }

    data.results.forEach((s, i) => {
        const statusBadge = s.finished_at 
            ? `<span class="badge badge-completed px-3 py-2">Completed</span>`
            : `<span class="badge badge-progress px-3 py-2">In Progress</span>`;

        const score = s.score !== null ? `<strong class="text-success fs-5">${s.score}</strong>` : `<span class="text-muted">—</span>`;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="text-center fw-bold">${i + 1}</td>
            <td><strong>${s.roll_no || "—"}</strong></td>
            <td class="fw-bold">${s.name || "—"}</td>
            <td>${s.email || "—"}</td>
            <td>${s.phone || "—"}</td>
            <td>${score}</td>
            <td>${statusBadge}</td>
            <td><small>${s.started_at ? new Date(s.started_at).toLocaleString('en-IN') : "—"}</small></td>
            <td>
                <a href="student-result-detail.html?attempt=${s.attempt_id}" 
                   class="btn btn-sm btn-primary fw-bold">VIEW</a>
            </td>
        `;
        tbody.appendChild(row);
    });
})
.catch(err => {
    console.error(err);
    document.getElementById("studentsList").innerHTML = `<tr><td colspan="9" class="text-center text-danger py-5">Failed to load students</td></tr>`;
});
</script>

</body>
</html>