<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Results</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-4">

    <div class="text-center mb-4">
        <h2>Exam Results</h2>
        <p class="text-muted">All student attempts</p>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Roll No</th>
                <th>Name</th>
                <th>Score</th>
                <th>Started At</th>
                <th>Finished At</th>
                <th>Details</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody id="results-table">
            <!-- Dynamic rows -->
        </tbody>
    </table>

    <div class="text-center mt-3">
        <a href="admin-dashboard.html">‚¨Ö Back to Dashboard</a>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="../admin.js"></script>
<script>
if (!localStorage.getItem("adminToken")) {
    window.location.href = "admin-login.html";
}

loadResults();
</script>

<!-- PRINT RESULT BUTTON -->
<div class="text-center my-5">
    <button onclick="printResults()" class="btn btn-primary btn-lg px-5 shadow">
        üñ®Ô∏è Print All Results
    </button>
</div>

<style>
@media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; left: 0; top: 0; width: 100%; }
    .no-print { display: none !important; }
    .table { font-size: 14px; }
    .table th, .table td { padding: 8px !important; }
}
</style>

<div id="printArea" class="container">
    <div class="text-center my-5">
        <h1>Manipal Online Assesment - Exam Results</h1>
        <h4>Date: <span id="printDate"></span></h4>
        <p>Total Students: <strong id="totalStudents">0</strong></p>
    </div>

    <table class="table table-bordered table-striped" id="printTable">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Roll No</th>
                <th>Name</th>
                <th>Score</th>
                <th>Started At</th>
                <th>Finished At</th>
            </tr>
        </thead>
        <tbody id="printTableBody">
            <!-- Filled by JS -->
        </tbody>
    </table>

    <div class="text-center mt-5">
        <p><strong>Generated on:</strong> <span id="generatedDate"></span></p>
        <p>Signature: _________________________</p>
    </div>
</div>

<script>
// PRINT FUNCTION ‚Äî BEAUTIFUL & PROFESSIONAL
async function downloadAllResultsPDF() {
    // WAIT FOR TABLE TO LOAD FULLY
    await new Promise(resolve => setTimeout(resolve, 1500));

    const table = document.querySelector("#results-table") || document.querySelector("#studentsList");
    if (!table || table.rows.length <= 1) {
        alert("No data to download!");
        return;
    }

    const canvas = await html2canvas(table, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        logging: false
    });

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const imgWidth = 190;
    const pageHeight = 290;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;
    let position = 20;

    // Title
    pdf.setFontSize(20);
    pdf.text("EXAM RESULTS - ALL STUDENTS", 105, 15, { align: "center" });
    pdf.setFontSize(12);
    pdf.text(`Generated: ${new Date().toLocaleString()}`, 105, position, { align: "center" });
    position += 10;

    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
        position = heightLeft - imgHeight + 20;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    pdf.save(`Exam_Results_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>

</body>
</html>
